version: "3.8"

services:
  db:
    image: leto-db
    networks:
      - backend
    env_file: db.env
    volumes: 
      - db-data:/var/lib/postgresql/data
  api:
    image: leto-api
    networks:
      - backend
      - traefik-public
    env_file: api.env
    deploy:
      labels:
        - traefik.http.routers.leto-api.rule=Host(`leto.sbb.sk`) && Path(`/api`)
        - traefik.http.routers.leto-api-https.tls.certresolver=le
        - traefik.http.services.leto-api.loadbalancer.server.port=5000
        - traefik.http.middlewares.https-redirect
        - traefik.enable=true
  form:
    image: leto-form
    networks:
      - traefik-public
    deploy:
      labels:
        - traefik.http.routers.leto-form.rule=Host(`leto.sbb.sk`)
        - traefik.http.routers.leto-form-https.tls.certresolver=le
        - traefik.http.services.leto-form.loadbalancer.server.port=80
        - traefik.http.middlewares.https-redirect
        - traefik.enable=true
  admin:
    image: leto-admin
    networks:
      - traefik-public
    deploy:
      labels:
        - traefik.http.routers.leto-admin.rule=Host(`leto.sbb.sk`) && Path(`/admin`)
        - traefik.http.routers.leto-form-admin.tls.certresolver=le
        - traefik.http.services.leto-admin.loadbalancer.server.port=80
        - traefik.http.middlewares.https-redirect
        - traefik.enable=true
  pgadmin:
    image: dpage/pgadmin4
    volumes:
      - pgadmin:/var/lib/pgadmin
    env_file: pgadmin.env
    ports:
     - "5050:80"
    networks:
      - backend
  
volumes: 
  db-data:
  pgadmin:

networks:
  backend:
  traefik-public:
    external: true